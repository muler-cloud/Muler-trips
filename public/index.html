<!DOCTYPE html>

<html lang="ru"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <title>TravelSplit - Израиль</title> <script src=""></script> <link rel="stylesheet" href=""> <style> .hidden { display: none; } body { font-family: -apple-system, system-ui, sans-serif; } </style> </head> <body class="bg-gray-50 min-h-screen pb-24">

</body> </html>
<script>
    let currentTripId = null;

    // Переключение экранов
    function showScreen(id) {
        document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
        document.getElementById('actionButtons').classList.add('hidden');
        
        const target = document.getElementById(id);
        if (target) {
            target.classList.remove('hidden');
            if (id === 'trip-view') document.getElementById('actionButtons').classList.remove('hidden');
        }
    }

    function goHome() {
        currentTripId = null;
        showScreen('home-view');
        loadTrips();
    }

    async function loadTrips() {
        const res = await fetch('/api/trips');
        const trips = await res.json();
        const list = document.getElementById('tripsList');
        const data = Array.isArray(trips) ? trips : [];
        list.innerHTML = data.map(t => `
            <div onclick="openTrip('${t.id}')" class="bg-white p-5 rounded-2xl shadow-sm border flex justify-between items-center cursor-pointer">
                <span class="font-bold text-lg">${t.name}</span>
                <i class="fas fa-chevron-right text-gray-300"></i>
            </div>
        `).join('') || '<p class="text-center text-gray-400 py-10">Поездок пока нет</p>';
    }

    async function createTrip() {
        const name = document.getElementById('newTripName').value.trim();
        if(!name) return alert("Введите название!");
        const res = await fetch('/api/trips', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name })
        });
        const data = await res.json();
        openTrip(data.id);
    }

    async function openTrip(id) {
        currentTripId = id;
        showScreen('trip-view');
        loadTripData();
    }

    async function loadTripData() {
        const res = await fetch(`/api/trips/${currentTripId}`);
        const data = await res.json();
        document.getElementById('tripTitle').innerText = data.trip.name;

        // Отрисовка баланса
        const balDiv = document.getElementById('balances');
        balDiv.innerHTML = data.participants.map(p => {
            const b = data.balances[p.id] || 0;
            return `
                <div class="flex justify-between items-center py-1">
                    <span class="font-medium">${p.name}</span>
                    <span class="${b >= 0 ? 'text-green-600' : 'text-red-500'} font-bold">
                        ${b > 0 ? '+' : ''}${b.toFixed(2)}
                    </span>
                </div>`;
        }).join('') || '<p class="text-gray-400 text-sm">Добавьте участников</p>';

        // Отрисовка расходов
        const expDiv = document.getElementById('expensesList');
        expDiv.innerHTML = data.expenses.slice().reverse().map(e => {
            // ВАЖНО: Ищем участника, сравнивая и строки и числа
            const payer = data.participants.find(p => String(p.id) === String(e.payer_id))?.name || 'Кто-то';
            return `
                <div class="bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm">
                    <div>
                        <div class="font-bold text-gray-800">${e.description}</div>
                        <div class="text-xs text-gray-500 italic">Заплатил: ${payer}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-600">${parseFloat(e.amount).toFixed(2)}</div>
                        <div class="text-[10px] text-gray-400">${e.date || ''}</div>
                    </div>
                </div>`;
        }).join('') || '<p class="text-center text-gray-300 text-sm py-4">Расходов пока нет</p>';
    }

    async function openParticipantModal() {
        const name = prompt("Имя участника:");
        if(!name) return;
        await fetch(`/api/trips/${currentTripId}/participants`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name })
        });
        loadTripData();
    }

    async function openExpenseModal() {
        const res = await fetch(`/api/trips/${currentTripId}`);
        const data = await res.json();
        
        if(!data.participants || data.participants.length === 0) {
            return alert("Сначала добавьте участников!");
        }

        const amount = prompt("Сумма:");
        if(!amount || isNaN(amount)) return;

        const desc = prompt("За что?");
        if(!desc) return;

        // Выбор плательщика
        const menu = data.participants.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
        const choice = prompt("Кто платил? Введите номер:\n" + menu);
        const index = parseInt(choice) - 1;
        
        if (data.participants[index]) {
            await fetch(`/api/trips/${currentTripId}/expenses`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    payer_id: data.participants[index].id, 
                    amount: parseFloat(amount), 
                    description: desc,
                    date: new Date().toLocaleDateString('ru-RU')
                })
            });
            loadTripData();
        } else {
            alert("Неверный номер!");
        }
    }

    window.onload = loadTrips;
</script>
